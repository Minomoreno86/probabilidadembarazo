name: ğŸš€ CI/CD - PronÃ³stico Fertilidad

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  XCODE_VERSION: '16.0'
  IOS_VERSION: '18.5'
  DEVICE: 'iPhone 16'

jobs:
  # ğŸ§ª TESTS UNITARIOS E INTEGRACIÃ“N
  unit-tests:
    name: ğŸ§ª Tests Unitarios e IntegraciÃ³n
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ“± Setup iOS Simulator
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: ğŸ§ª Ejecutar Tests Unitarios
      run: |
        echo "ğŸš€ Ejecutando tests unitarios..."
        xcodebuild test \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -enableCodeCoverage YES \
          -resultBundlePath "TestResults.xcresult" \
          | xcpretty --color --simple
        
    - name: ğŸ“Š Generar Reporte de Cobertura
      run: |
        echo "ğŸ“Š Generando reporte de cobertura..."
        xcrun xccov view --report --json TestResults.xcresult > coverage.json
        
    - name: ğŸ’¾ Subir Reportes de Test
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          TestResults.xcresult
          coverage.json
          
    - name: ğŸ“ˆ Comentar Cobertura en PR
      if: github.event_name == 'pull_request'
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: coverage.info

  # ğŸ¨ TESTS DE UI
  ui-tests:
    name: ğŸ¨ Tests de UI
    runs-on: macos-latest
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ“± Setup iOS Simulator
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: ğŸ¨ Ejecutar Tests de UI
      run: |
        echo "ğŸ¨ Ejecutando tests de UI..."
        xcodebuild test \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidadUITests" \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -resultBundlePath "UITestResults.xcresult" \
          | xcpretty --color --simple
        
    - name: ğŸ’¾ Subir Resultados de UI Tests
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-results
        path: UITestResults.xcresult

  # ğŸ—ï¸ BUILD Y VALIDACIÃ“N
  build:
    name: ğŸ—ï¸ Build y ValidaciÃ³n
    runs-on: macos-latest
    needs: [unit-tests, ui-tests]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ” Setup Code Signing
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: ğŸ—ï¸ Build para Simulador
      run: |
        echo "ğŸ—ï¸ Construyendo para simulador..."
        xcodebuild build \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -configuration Debug \
          | xcpretty --color --simple
          
    - name: ğŸ—ï¸ Build para Dispositivo
      run: |
        echo "ğŸ—ï¸ Construyendo para dispositivo..."
        xcodebuild build \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -configuration Release \
          -destination generic/platform=iOS \
          | xcpretty --color --simple
          
    - name: ğŸ” Validar Build
      run: |
        echo "ğŸ” Validando build..."
        if [ -d "build" ]; then
          echo "âœ… Build exitoso"
          ls -la build/
        else
          echo "âŒ Build fallÃ³"
          exit 1
        fi

  # ğŸ“± DEPLOYMENT A TESTFLIGHT
  deploy-testflight:
    name: ğŸ“± Deploy a TestFlight
    runs-on: macos-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ” Setup Code Signing
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: ğŸ“± Build para TestFlight
      run: |
        echo "ğŸ“± Construyendo para TestFlight..."
        xcodebuild archive \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -configuration Release \
          -archivePath "PronosticoFertilidad.xcarchive" \
          -destination generic/platform=iOS \
          | xcpretty --color --simple
          
    - name: ğŸ“¦ Exportar IPA
      run: |
        echo "ğŸ“¦ Exportando IPA..."
        xcodebuild -exportArchive \
          -archivePath "PronosticoFertilidad.xcarchive" \
          -exportPath "export" \
          -exportOptionsPlist "exportOptions.plist" \
          | xcpretty --color --simple
          
    - name: ğŸš€ Subir a TestFlight
      uses: apple-actions/upload-testflight@v1
      with:
        app-path: export/Pronostico\ fertilidad.ipa
        api-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        api-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

  # ğŸ” ANÃLISIS DE CÃ“DIGO
  code-analysis:
    name: ğŸ” AnÃ¡lisis de CÃ³digo
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ” Analizar CÃ³digo
      run: |
        echo "ğŸ” Analizando cÃ³digo..."
        xcodebuild analyze \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          | xcpretty --color --simple

  # ğŸ“Š REPORTES Y NOTIFICACIONES
  reports:
    name: ğŸ“Š Reportes y Notificaciones
    runs-on: macos-latest
    needs: [unit-tests, ui-tests, build, code-analysis]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Generar Reporte de Calidad
      run: |
        echo "ğŸ“Š Generando reporte de calidad..."
        echo "# ğŸ“Š Reporte de Calidad - $(date)" > quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ§ª Tests" >> quality-report.md
        echo "- Unitarios: âœ… Completados" >> quality-report.md
        echo "- UI: âœ… Completados" >> quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ—ï¸ Build" >> quality-report.md
        echo "- Simulador: âœ… Exitoso" >> quality-report.md
        echo "- Dispositivo: âœ… Exitoso" >> quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ” AnÃ¡lisis" >> quality-report.md
        echo "- CÃ³digo: âœ… Analizado" >> quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ“± Deployment" >> quality-report.md
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "- TestFlight: âœ… Desplegado" >> quality-report.md
        else
          echo "- TestFlight: â¸ï¸ Solo en main" >> quality-report.md
        fi
        
    - name: ğŸ’¾ Subir Reporte
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality-report.md
        
    - name: ğŸ“§ Notificar por Email (opcional)
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âŒ CI/CD FallÃ³ - PronÃ³stico Fertilidad"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "CI/CD Bot <${{ secrets.EMAIL_USERNAME }}>"
        body: |
          El pipeline de CI/CD ha fallado en el commit ${{ github.sha }}
          
          Revisa los logs en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Autor: ${{ github.actor }}

  # ğŸš€ DEPLOYMENT AUTOMÃTICO
  auto-deploy:
    name: ğŸš€ Deployment AutomÃ¡tico
    runs-on: macos-latest
    needs: [unit-tests, ui-tests, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Crear Tag de Release
      run: |
        echo "ğŸ·ï¸ Creando tag de release..."
        VERSION=$(date +"%Y.%m.%d")
        git tag -a "v$VERSION" -m "Release automÃ¡tico v$VERSION"
        git push origin "v$VERSION"
        
    - name: ğŸ“ Crear Release en GitHub
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v${{ steps.get-version.outputs.version }}"
        release_name: "Release v${{ steps.get-version.outputs.version }}"
        body: |
          ğŸš€ Release automÃ¡tico generado por CI/CD
          
          ## âœ… Cambios incluidos:
          - Tests unitarios pasando
          - Tests de UI pasando
          - Build exitoso
          - AnÃ¡lisis de cÃ³digo limpio
          
          ## ğŸ“± Disponible en:
          - TestFlight (automÃ¡tico)
          - GitHub Releases
          
        draft: false
        prerelease: false

name: üöÄ CI/CD - Pronostico Fertilidad

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  XCODE_VERSION: '16.0'
  IOS_VERSION: '18.6'
  DEVICE: 'iPhone 16'

jobs:
  # üß™ JOB DE TESTS Y VALIDACI√ìN
  test-and-validate:
    name: üß™ Tests & Validaci√≥n
    runs-on: macos-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Para code coverage completo
      
      - name: üçé Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì± Listar simuladores disponibles
        run: |
          xcrun simctl list devices available
          echo "Simuladores iOS disponibles:"
          xcrun simctl list devices | grep "iPhone"
      
      - name: üîß Instalar dependencias
        run: |
          echo "Instalando dependencias..."
          # Aqu√≠ puedes agregar comandos para instalar dependencias si las hay
          echo "Dependencias instaladas ‚úÖ"
      
      - name: üß™ Ejecutar Tests Unitarios
        run: |
          echo "üß™ Ejecutando tests unitarios..."
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -only-testing:Pronostico_fertilidadTests \
            -enableCodeCoverage YES \
            -resultBundlePath "TestResults.xcresult" \
            | xcpretty
      
      - name: üß™ Ejecutar Tests Independientes (Sin Simulador)
        run: |
          echo "üß™ Ejecutando tests independientes..."
          swift scripts/enhanced_test_runner.swift
          
          # Capturar resultado del test runner
          TEST_OUTPUT=$(swift scripts/enhanced_test_runner.swift 2>&1)
          echo "$TEST_OUTPUT"
          
          # Extraer porcentaje de √©xito
          SUCCESS_RATE=$(echo "$TEST_OUTPUT" | grep "Porcentaje de √©xito:" | grep -o '[0-9]\+%' | head -1 | tr -d '%')
          
          # Verificar que al menos 95% de tests pasen
          if [ "$SUCCESS_RATE" -lt 95 ]; then
            echo "‚ùå Cobertura insuficiente: $SUCCESS_RATE% (m√≠nimo requerido: 95%)"
            exit 1
          else
            echo "‚úÖ Cobertura suficiente: $SUCCESS_RATE%"
          fi
      
      - name: üß™ Ejecutar Tests UI
        run: |
          echo "üß™ Ejecutando tests UI..."
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -only-testing:Pronostico_fertilidadUITests \
            -skip-testing:Pronostico_fertilidadUITests/PerformanceTests \
            -enableCodeCoverage YES \
            -resultBundlePath "UITestResults.xcresult" \
            | xcpretty
      
      - name: üìä Generar Code Coverage
        run: |
          echo "üìä Generando reporte de code coverage..."
          xcrun xccov view --report --files-for-target "Pronostico fertilidad" TestResults.xcresult
          xcrun xccov view --report --files-for-target "Pronostico fertilidad" UITestResults.xcresult
          
          # Extraer m√©tricas de cobertura
          COVERAGE_REPORT=$(xcrun xccov view --report --files-for-target "Pronostico fertilidad" TestResults.xcresult)
          echo "$COVERAGE_REPORT"
          
          # Verificar cobertura m√≠nima (80%)
          TOTAL_COVERAGE=$(echo "$COVERAGE_REPORT" | grep "TOTAL" | grep -o '[0-9]\+\.[0-9]\+%' | head -1 | tr -d '%')
          
          if [ -n "$TOTAL_COVERAGE" ] && [ "$(echo "$TOTAL_COVERAGE < 80" | bc -l)" -eq 1 ]; then
            echo "‚ùå Cobertura de c√≥digo insuficiente: $TOTAL_COVERAGE% (m√≠nimo requerido: 80%)"
            echo "üö® BLOQUEANDO PR - Cobertura insuficiente"
            exit 1
          else
            echo "‚úÖ Cobertura de c√≥digo suficiente: $TOTAL_COVERAGE%"
          fi
      
      - name: üì¶ Subir resultados de tests
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            TestResults.xcresult
            UITestResults.xcresult
          retention-days: 30
      
      - name: üìà Reporte de Code Coverage
        uses: romeovs/lcov-reporter-action@v0.3.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: coverage.info
      
      - name: üìß Notificar resultados
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üß™ Tests Pronostico Fertilidad - ${{ job.status }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions"
          body: |
            Tests ejecutados para Pronostico Fertilidad
            
            Estado: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            
            Ver detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # üèóÔ∏è JOB DE BUILD Y AN√ÅLISIS
  build-and-analyze:
    name: üèóÔ∏è Build & An√°lisis
    runs-on: macos-latest
    needs: test-and-validate
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üçé Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üîç An√°lisis est√°tico del c√≥digo
        run: |
          echo "üîç Ejecutando an√°lisis est√°tico..."
          xcodebuild analyze \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            | xcpretty
      
      - name: üèóÔ∏è Build de la aplicaci√≥n
        run: |
          echo "üèóÔ∏è Construyendo aplicaci√≥n..."
          xcodebuild build \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -configuration Debug \
            | xcpretty
      
      - name: üì± Build para simulador
        run: |
          echo "üì± Construyendo para simulador..."
          xcodebuild build \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -configuration Release \
            | xcpretty

  # üöÄ JOB DE DESPLIEGUE (OPCIONAL)
  deploy:
    name: üöÄ Despliegue
    runs-on: macos-latest
    needs: [test-and-validate, build-and-analyze]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üçé Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üè∑Ô∏è Crear Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            üöÄ Release autom√°tico de Pronostico Fertilidad
            
            ## Cambios incluidos:
            - Tests ejecutados exitosamente
            - Build validado
            - An√°lisis est√°tico completado
            
            ## Detalles t√©cnicos:
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}
          draft: false
          prerelease: false

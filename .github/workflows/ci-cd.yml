name: ğŸš€ CI/CD - Pronostico Fertilidad

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  XCODE_VERSION: '16.0'
  IOS_VERSION: '18.6'
  DEVICE: 'iPhone 16'

jobs:
  # ğŸ§ª JOB DE TESTS Y VALIDACIÃ“N
  test-and-validate:
    name: ğŸ§ª Tests & ValidaciÃ³n
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Para code coverage completo
      
      - name: ğŸ Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸ“± Listar simuladores disponibles
        run: |
          xcrun simctl list devices available
          echo "Simuladores iOS disponibles:"
          xcrun simctl list devices | grep "iPhone"
      
      - name: ğŸ”§ Instalar dependencias
        run: |
          echo "Instalando dependencias..."
          # AquÃ­ puedes agregar comandos para instalar dependencias si las hay
          echo "Dependencias instaladas âœ…"
      
      - name: ğŸ§ª Ejecutar Tests Unitarios
        run: |
          echo "ğŸ§ª Ejecutando tests unitarios..."
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -only-testing:Pronostico_fertilidadTests \
            -enableCodeCoverage YES \
            -resultBundlePath "TestResults.xcresult" \
            | xcpretty
      
      - name: ğŸ§ª Ejecutar Tests UI
        run: |
          echo "ğŸ§ª Ejecutando tests UI..."
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -only-testing:Pronostico_fertilidadUITests \
            -enableCodeCoverage YES \
            -resultBundlePath "UITestResults.xcresult" \
            | xcpretty
      
      - name: ğŸ“Š Generar Code Coverage
        run: |
          echo "ğŸ“Š Generando reporte de code coverage..."
          xcrun xccov view --report --files-for-target "Pronostico fertilidad" TestResults.xcresult
          xcrun xccov view --report --files-for-target "Pronostico fertilidad" UITestResults.xcresult
      
      - name: ğŸ“¦ Subir resultados de tests
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            TestResults.xcresult
            UITestResults.xcresult
          retention-days: 30
      
      - name: ğŸ“ˆ Reporte de Code Coverage
        uses: romeovs/lcov-reporter-action@v0.3.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: coverage.info
      
      - name: ğŸ“§ Notificar resultados
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ§ª Tests Pronostico Fertilidad - ${{ job.status }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions"
          body: |
            Tests ejecutados para Pronostico Fertilidad
            
            Estado: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            
            Ver detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ğŸ—ï¸ JOB DE BUILD Y ANÃLISIS
  build-and-analyze:
    name: ğŸ—ï¸ Build & AnÃ¡lisis
    runs-on: macos-latest
    needs: test-and-validate
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸ” AnÃ¡lisis estÃ¡tico del cÃ³digo
        run: |
          echo "ğŸ” Ejecutando anÃ¡lisis estÃ¡tico..."
          xcodebuild analyze \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            | xcpretty
      
      - name: ğŸ—ï¸ Build de la aplicaciÃ³n
        run: |
          echo "ğŸ—ï¸ Construyendo aplicaciÃ³n..."
          xcodebuild build \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -configuration Debug \
            | xcpretty
      
      - name: ğŸ“± Build para simulador
        run: |
          echo "ğŸ“± Construyendo para simulador..."
          xcodebuild build \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -configuration Release \
            | xcpretty

  # ğŸš€ JOB DE DESPLIEGUE (OPCIONAL)
  deploy:
    name: ğŸš€ Despliegue
    runs-on: macos-latest
    needs: [test-and-validate, build-and-analyze]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸ·ï¸ Crear Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ğŸš€ Release automÃ¡tico de Pronostico Fertilidad
            
            ## Cambios incluidos:
            - Tests ejecutados exitosamente
            - Build validado
            - AnÃ¡lisis estÃ¡tico completado
            
            ## Detalles tÃ©cnicos:
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}
          draft: false
          prerelease: false

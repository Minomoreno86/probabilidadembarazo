name: âš¡ Tests de Rendimiento

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar tests de rendimiento diariamente a las 2 AM
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  XCODE_VERSION: '16.0'
  IOS_VERSION: '18.5'
  DEVICE: 'iPhone 16'

jobs:
  performance-tests:
    name: âš¡ Tests de Rendimiento
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ“± Setup iOS Simulator
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: âš¡ Ejecutar Tests de Rendimiento
      run: |
        echo "âš¡ Ejecutando tests de rendimiento..."
        xcodebuild test \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -only-testing:Pronostico_fertilidadTests/PerformanceTestRunner \
          -resultBundlePath "PerformanceTestResults.xcresult" \
          | xcpretty --color --simple
        
    - name: ğŸ“Š Analizar MÃ©tricas de Rendimiento
      run: |
        echo "ğŸ“Š Analizando mÃ©tricas de rendimiento..."
        
        # Extraer mÃ©tricas de los tests
        xcrun xccov view --report --json PerformanceTestResults.xcresult > performance-metrics.json
        
        # Analizar tiempos de ejecuciÃ³n
        echo "## âš¡ MÃ©tricas de Rendimiento" > performance-report.md
        echo "" >> performance-report.md
        echo "### ğŸ• Tiempos de EjecuciÃ³n:" >> performance-report.md
        echo "- Tests Unitarios: $(grep -o 'Test.*completed in [0-9.]*s' PerformanceTestResults.xcresult | head -1)" >> performance-report.md
        echo "- Tests de UI: $(grep -o 'UI.*completed in [0-9.]*s' PerformanceTestResults.xcresult | head -1)" >> performance-report.md
        echo "" >> performance-report.md
        echo "### ğŸ“ˆ Cobertura de Tests:" >> performance-report.md
        echo "- Total Tests: $(grep -c 'Test.*passed' PerformanceTestResults.xcresult)" >> performance-report.md
        echo "- Tests Pasaron: $(grep -c 'Test.*passed' PerformanceTestResults.xcresult)" >> performance-report.md
        echo "- Tests Fallaron: $(grep -c 'Test.*failed' PerformanceTestResults.xcresult)" >> performance-report.md
        
    - name: ğŸ’¾ Subir Reportes de Rendimiento
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: |
          PerformanceTestResults.xcresult
          performance-metrics.json
          performance-report.md
          
    - name: ğŸ“Š Comentar MÃ©tricas en PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('performance-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âš¡ Reporte de Rendimiento\n\n${report}\n\nğŸ“Š [Ver logs completos](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          });

  memory-leak-tests:
    name: ğŸ§  Tests de Memory Leaks
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ§  Ejecutar Tests de Memory
      run: |
        echo "ğŸ§  Ejecutando tests de memory leaks..."
        
        # Ejecutar tests con instrumentos de memory
        xcodebuild test \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -enableCodeCoverage YES \
          -resultBundlePath "MemoryTestResults.xcresult" \
          | xcpretty --color --simple
        
        # Analizar uso de memory
        echo "ğŸ“Š Analizando uso de memory..."
        xcrun xccov view --report --json MemoryTestResults.xcresult > memory-analysis.json
        
    - name: ğŸ’¾ Subir AnÃ¡lisis de Memory
      uses: actions/upload-artifact@v4
      with:
        name: memory-analysis
        path: |
          MemoryTestResults.xcresult
          memory-analysis.json

  load-tests:
    name: ğŸ”¥ Tests de Carga
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ”¥ Ejecutar Tests de Carga
      run: |
        echo "ğŸ”¥ Ejecutando tests de carga..."
        
        # Simular mÃºltiples usuarios simultÃ¡neos
        for i in {1..5}; do
          echo "ğŸ§ª Usuario $i ejecutando tests..."
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -resultBundlePath "LoadTestResults_$i.xcresult" \
            | xcpretty --color --simple &
        done
        
        # Esperar a que todos terminen
        wait
        
        echo "âœ… Todos los tests de carga completados"
        
    - name: ğŸ“Š Analizar Tests de Carga
      run: |
        echo "ğŸ“Š Analizando resultados de carga..."
        
        echo "## ğŸ”¥ Reporte de Tests de Carga" > load-test-report.md
        echo "" >> load-test-report.md
        echo "### ğŸ“± Usuarios SimultÃ¡neos: 5" >> load-test-report.md
        echo "" >> load-test-report.md
        
        for i in {1..5}; do
          if [ -f "LoadTestResults_$i.xcresult" ]; then
            echo "#### ğŸ‘¤ Usuario $i:" >> load-test-report.md
            echo "- Tests Pasaron: $(grep -c 'Test.*passed' LoadTestResults_$i.xcresult)" >> load-test-report.md
            echo "- Tests Fallaron: $(grep -c 'Test.*failed' LoadTestResults_$i.xcresult)" >> load-test-report.md
            echo "" >> load-test-report.md
          fi
        done
        
    - name: ğŸ’¾ Subir Tests de Carga
      uses: actions/upload-artifact@v4
      with:
        name: load-test-results
        path: |
          LoadTestResults_*.xcresult
          load-test-report.md

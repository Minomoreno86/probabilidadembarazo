name: âš¡ Performance Tests - Pronostico Fertilidad

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Pronostico fertilidadUITests/PerformanceTests.swift'
      - 'Pronostico fertilidad/**/*.swift'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Ejecutar tests de rendimiento cada domingo a las 3 AM UTC
    - cron: '0 3 * * 0'

env:
  DEVICE: "iPhone 16"
  IOS_VERSION: "18.6"
  PERFORMANCE_TIMEOUT: 300  # 5 minutos para tests de rendimiento

jobs:
  performance-tests:
    name: âš¡ Tests de Rendimiento
    runs-on: macos-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸŽ Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'
      
      - name: ðŸ”§ Configurar Simulador
        run: |
          echo "ðŸ”§ Configurando simulador para tests de rendimiento..."
          
          # Listar simuladores disponibles
          xcrun simctl list devices available
          
          # Crear simulador especÃ­fico para rendimiento si no existe
          SIMULATOR_ID=$(xcrun simctl create "Performance Test iPhone" "iPhone 16" "iOS 18.6" 2>/dev/null || echo "")
          
          if [ -n "$SIMULATOR_ID" ]; then
            echo "âœ… Simulador creado: $SIMULATOR_ID"
          else
            echo "â„¹ï¸  Usando simulador existente"
          fi
      
      - name: âš¡ Ejecutar Tests de Rendimiento
        run: |
          echo "âš¡ Ejecutando tests de rendimiento optimizados..."
          
          # Configurar variables de entorno para tests de rendimiento
          export XCTEST_TIMEOUT=300
          export XCTEST_PERFORMANCE_METRICS=1
          
          # Ejecutar solo tests de rendimiento con timeouts generosos
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
            -only-testing:Pronostico_fertilidadUITests/PerformanceTests \
            -test-timeout 300 \
            -parallel-testing-enabled NO \
            -maximum-concurrent-test-simulator-destinations 1 \
            | xcpretty --color
      
      - name: ðŸ“Š Analizar Resultados de Rendimiento
        run: |
          echo "ðŸ“Š Analizando resultados de rendimiento..."
          
          # Extraer mÃ©tricas de rendimiento del log
          if grep -q "Test Case.*PerformanceTests.*passed" xcodebuild.log; then
            echo "âœ… Tests de rendimiento pasaron"
            echo "ðŸ“ˆ MÃ©tricas de rendimiento:"
            grep -A 5 -B 5 "measure" xcodebuild.log || echo "No se encontraron mÃ©tricas especÃ­ficas"
          else
            echo "âŒ Algunos tests de rendimiento fallaron"
            echo "ðŸ” Revisando logs de error..."
            grep -A 10 -B 5 "FAILED" xcodebuild.log || echo "No se encontraron errores especÃ­ficos"
            exit 1
          fi
      
      - name: ðŸ§¹ Limpiar Simulador
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando simulador..."
          xcrun simctl shutdown all 2>/dev/null || true
          xcrun simctl erase all 2>/dev/null || true
      
      - name: ðŸ“‹ Reporte de Rendimiento
        if: always()
        run: |
          echo "ðŸ“‹ Generando reporte de rendimiento..."
          
          echo "## âš¡ Reporte de Tests de Rendimiento" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Resumen:" >> $GITHUB_STEP_SUMMARY
          echo "- **Dispositivo:** ${{ env.DEVICE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS Version:** ${{ env.IOS_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timeout:** ${{ env.PERFORMANCE_TIMEOUT }} segundos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $? -eq 0 ]; then
            echo "âœ… **Estado:** Tests de rendimiento exitosos" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Rendimiento:** Dentro de los lÃ­mites esperados" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Estado:** Tests de rendimiento fallaron" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **AcciÃ³n:** Revisar mÃ©tricas y optimizar cÃ³digo" >> $GITHUB_STEP_SUMMARY
          fi

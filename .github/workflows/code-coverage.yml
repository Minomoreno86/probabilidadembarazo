name: ğŸ“Š Code Coverage Analysis - Pronostico Fertilidad

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Ejecutar cada domingo a las 2 AM UTC
    - cron: '0 2 * * 0'

env:
  MIN_COVERAGE: 80
  TARGET_COVERAGE: 90

jobs:
  coverage-analysis:
    name: ğŸ“Š AnÃ¡lisis de Cobertura
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Configurar Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'
      
      - name: ğŸ§ª Ejecutar Tests con Cobertura
        run: |
          echo "ğŸ§ª Ejecutando tests con cobertura completa..."
          
          # Limpiar resultados anteriores
          rm -rf CoverageResults.xcresult
          
          # Ejecutar tests con cobertura
          xcodebuild test \
            -project "Pronostico fertilidad.xcodeproj" \
            -scheme "Pronostico fertilidad" \
            -destination "platform=iOS Simulator,name=iPhone 16" \
            -enableCodeCoverage YES \
            -resultBundlePath "CoverageResults.xcresult" \
            | xcpretty
      
      - name: ğŸ“Š Generar Reporte Detallado
        run: |
          echo "ğŸ“Š Generando reporte detallado de cobertura..."
          
          if [ -d "CoverageResults.xcresult" ]; then
            # Reporte general
            echo "=== ğŸ“Š REPORTE GENERAL DE COBERTURA ==="
            xcrun xccov view --report --files-for-target "Pronostico fertilidad" CoverageResults.xcresult
            
            # Reporte por archivo
            echo -e "\n=== ğŸ“ COBERTURA POR ARCHIVO ==="
            xcrun xccov view --report --files-for-target "Pronostico fertilidad" CoverageResults.xcresult | grep -E "\.swift" | sort -k2 -nr
            
            # MÃ©tricas clave
            TOTAL_COVERAGE=$(xcrun xccov view --report --files-for-target "Pronostico fertilidad" CoverageResults.xcresult | grep "TOTAL" | grep -o '[0-9]\+\.[0-9]\+%' | head -1 | tr -d '%')
            
            echo -e "\n=== ğŸ¯ MÃ‰TRICAS CLAVE ==="
            echo "Cobertura total: $TOTAL_COVERAGE%"
            echo "MÃ­nimo requerido: ${{ env.MIN_COVERAGE }}%"
            echo "Objetivo: ${{ env.TARGET_COVERAGE }}%"
            
            # Verificar umbrales
            if [ -n "$TOTAL_COVERAGE" ]; then
              if [ "$(echo "$TOTAL_COVERAGE < ${{ env.MIN_COVERAGE }}" | bc -l)" -eq 1 ]; then
                echo "âŒ CRÃTICO: Cobertura insuficiente ($TOTAL_COVERAGE%)"
                echo "ğŸš¨ BLOQUEANDO - No cumple estÃ¡ndares mÃ­nimos"
                exit 1
              elif [ "$(echo "$TOTAL_COVERAGE < ${{ env.TARGET_COVERAGE }}" | bc -l)" -eq 1 ]; then
                echo "âš ï¸  ADVERTENCIA: Cobertura por debajo del objetivo ($TOTAL_COVERAGE%)"
                echo "ğŸ’¡ RecomendaciÃ³n: Mejorar cobertura para alcanzar ${{ env.TARGET_COVERAGE }}%"
              else
                echo "âœ… EXCELENTE: Cobertura objetivo alcanzada ($TOTAL_COVERAGE%)"
              fi
            else
              echo "âš ï¸  No se pudo determinar cobertura total"
            fi
          else
            echo "âŒ Error: No se generÃ³ archivo de cobertura"
            exit 1
          fi
      
      - name: ğŸ” AnÃ¡lisis de Archivos Sin Cobertura
        run: |
          echo "ğŸ” Analizando archivos sin cobertura..."
          
          if [ -d "CoverageResults.xcresult" ]; then
            # Identificar archivos con 0% cobertura
            echo "=== ğŸš¨ ARCHIVOS SIN COBERTURA ==="
            xcrun xccov view --report --files-for-target "Pronostico fertilidad" CoverageResults.xcresult | grep "0.00%" | sort
            
            # Contar archivos sin cobertura
            UNCOVERED_FILES=$(xcrun xccov view --report --files-for-target "Pronostico fertilidad" CoverageResults.xcresult | grep "0.00%" | wc -l | tr -d ' ')
            echo -e "\nğŸ“Š Total archivos sin cobertura: $UNCOVERED_FILES"
            
            if [ "$UNCOVERED_FILES" -gt 5 ]; then
              echo "âš ï¸  Muchos archivos sin cobertura - Revisar prioridades"
            elif [ "$UNCOVERED_FILES" -gt 0 ]; then
              echo "ğŸ’¡ Algunos archivos sin cobertura - Considerar tests adicionales"
            else
              echo "ğŸ‰ Â¡Todos los archivos tienen cobertura!"
            fi
          fi
      
      - name: ğŸ“ˆ Generar Badge de Cobertura
        run: |
          echo "ğŸ“ˆ Generando badge de cobertura..."
          
          if [ -d "CoverageResults.xcresult" ]; then
            TOTAL_COVERAGE=$(xcrun xccov view --report --files-for-target "Pronostico fertilidad" CoverageResults.xcresult | grep "TOTAL" | grep -o '[0-9]\+\.[0-9]\+%' | head -1 | tr -d '%')
            
            if [ -n "$TOTAL_COVERAGE" ]; then
              # Crear badge SVG
              if [ "$(echo "$TOTAL_COVERAGE >= 90" | bc -l)" -eq 1 ]; then
                COLOR="brightgreen"
                STATUS="excellent"
              elif [ "$(echo "$TOTAL_COVERAGE >= 80" | bc -l)" -eq 1 ]; then
                COLOR="green"
                STATUS="good"
              elif [ "$(echo "$TOTAL_COVERAGE >= 70" | bc -l)" -eq 1 ]; then
                COLOR="yellow"
                STATUS="fair"
              elif [ "$(echo "$TOTAL_COVERAGE >= 60" | bc -l)" -eq 1 ]; then
                COLOR="orange"
                STATUS="poor"
              else
                COLOR="red"
                STATUS="critical"
              fi
              
              echo "ğŸ¨ Color del badge: $COLOR ($STATUS)"
              echo "ğŸ“Š Cobertura para badge: $TOTAL_COVERAGE%"
            fi
          fi
      
      - name: ğŸ“¦ Subir Resultados
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-analysis-results
          path: |
            CoverageResults.xcresult
          retention-days: 30
      
      - name: ğŸ“§ Notificar Resultado
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ AnÃ¡lisis de cobertura completado exitosamente"
          else
            echo "âŒ AnÃ¡lisis de cobertura fallÃ³"
          fi

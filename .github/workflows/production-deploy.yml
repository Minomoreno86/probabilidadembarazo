name: ğŸš€ Deployment a ProducciÃ³n

on:
  push:
    tags:
      - 'v*.*.*'  # Solo cuando se crea un tag de versiÃ³n
  workflow_dispatch:
    inputs:
      version:
        description: 'VersiÃ³n a desplegar'
        required: true
        default: '1.0.0'
      environment:
        description: 'Ambiente de deployment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  XCODE_VERSION: '16.0'
  IOS_VERSION: '18.5'

jobs:
  validate-release:
    name: âœ… Validar Release
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para tags
        
    - name: ğŸ·ï¸ Obtener VersiÃ³n
      id: get-version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          # Extraer versiÃ³n del tag
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ” Validar Cambios
      run: |
        echo "ğŸ” Validando cambios para versiÃ³n ${{ steps.get-version.outputs.version }}..."
        
        # Verificar que no haya cambios sin commitear
        if [ -n "$(git status --porcelain)" ]; then
          echo "âŒ Hay cambios sin commitear"
          git status
          exit 1
        fi
        
        # Verificar que el tag estÃ© en main
        if [ "${{ github.ref }}" != "refs/heads/main" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
          echo "âŒ El tag debe estar en la rama main"
          exit 1
        fi
        
        echo "âœ… ValidaciÃ³n exitosa"
        
    - name: ğŸ“‹ Generar Changelog
      run: |
        echo "ğŸ“‹ Generando changelog..."
        
        # Obtener commits desde el Ãºltimo tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "## ğŸ“‹ Cambios desde $PREVIOUS_TAG" > changelog.md
          echo "" >> changelog.md
          git log --oneline --no-merges $PREVIOUS_TAG..HEAD >> changelog.md
        else
          echo "## ğŸ“‹ Cambios iniciales" > changelog.md
          echo "" >> changelog.md
          git log --oneline --no-merges >> changelog.md
        fi
        
        echo "âœ… Changelog generado"
        cat changelog.md

  build-production:
    name: ğŸ—ï¸ Build de ProducciÃ³n
    runs-on: macos-latest
    needs: validate-release
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ğŸ” Setup Code Signing
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: ğŸ—ï¸ Build de ProducciÃ³n
      run: |
        echo "ğŸ—ï¸ Construyendo versiÃ³n de producciÃ³n..."
        
        # Build para archivo
        xcodebuild archive \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -configuration Release \
          -archivePath "PronosticoFertilidad.xcarchive" \
          -destination generic/platform=iOS \
          | xcpretty --color --simple
          
        echo "âœ… Build de producciÃ³n completado"
        
    - name: ğŸ“¦ Exportar IPA
      run: |
        echo "ğŸ“¦ Exportando IPA..."
        
        # Crear exportOptions.plist dinÃ¡mico
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>\${{ secrets.APP_STORE_TEAM_ID }}</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF
        
        # Exportar IPA
        xcodebuild -exportArchive \
          -archivePath "PronosticoFertilidad.xcarchive" \
          -exportPath "export" \
          -exportOptionsPlist "exportOptions.plist" \
          | xcpretty --color --simple
          
        echo "âœ… IPA exportado exitosamente"
        
    - name: ğŸ’¾ Subir Artefactos
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: |
          export/
          PronosticoFertilidad.xcarchive
          changelog.md

  deploy-testflight:
    name: ğŸ“± Deploy a TestFlight
    runs-on: macos-latest
    needs: build-production
    if: github.event.inputs.environment == 'staging' || github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Download Build
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: ğŸš€ Subir a TestFlight
      uses: apple-actions/upload-testflight@v1
      with:
        app-path: export/Pronostico\ fertilidad.ipa
        api-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        api-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        
    - name: ğŸ“§ Notificar TestFlight
      run: |
        echo "ğŸ“§ Notificando deployment a TestFlight..."
        echo "âœ… App subida a TestFlight exitosamente"
        echo "ğŸ·ï¸ VersiÃ³n: ${{ needs.validate-release.outputs.version }}"

  deploy-app-store:
    name: ğŸª Deploy a App Store
    runs-on: macos-latest
    needs: [build-production, deploy-testflight]
    if: github.event.inputs.environment == 'production' || github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Download Build
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: ğŸª Subir a App Store Connect
      uses: apple-actions/upload-testflight@v1
      with:
        app-path: export/Pronostico\ fertilidad.ipa
        api-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        api-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        
    - name: ğŸ“ Crear Release en GitHub
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v${{ needs.validate-release.outputs.version }}"
        release_name: "ğŸš€ Release v${{ needs.validate-release.outputs.version }}"
        body: |
          ## ğŸ‰ Nueva VersiÃ³n de ProducciÃ³n
          
          **VersiÃ³n:** ${{ needs.validate-release.outputs.version }}
          **Fecha:** $(date)
          
          ## ğŸ“‹ Cambios Incluidos
          
          $(cat changelog.md)
          
          ## ğŸ“± Disponible en
          - âœ… TestFlight (Testing)
          - ğŸª App Store (PrÃ³ximamente)
          
          ## ğŸ” Detalles TÃ©cnicos
          - Build: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Autor: ${{ github.actor }}
          
        draft: false
        prerelease: false
        
    - name: ğŸ“§ Notificar ProducciÃ³n
      run: |
        echo "ğŸª Notificando deployment a producciÃ³n..."
        echo "âœ… App subida a App Store Connect exitosamente"
        echo "ğŸ·ï¸ VersiÃ³n: ${{ needs.validate-release.outputs.version }}"

  post-deployment:
    name: ğŸ“Š Post-Deployment
    runs-on: ubuntu-latest
    needs: [deploy-testflight, deploy-app-store]
    if: always()
    
    steps:
    - name: ğŸ“¥ Download Artefactos
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: ğŸ“Š Generar Reporte de Deployment
      run: |
        echo "ğŸ“Š Generando reporte de deployment..."
        
        echo "# ğŸš€ Reporte de Deployment" > deployment-report.md
        echo "" >> deployment-report.md
        echo "## ğŸ“± InformaciÃ³n de la App" >> deployment-report.md
        echo "- **Nombre:** PronÃ³stico Fertilidad" >> deployment-report.md
        echo "- **VersiÃ³n:** ${{ needs.validate-release.outputs.version }}" >> deployment-report.md
        echo "- **Build:** ${{ github.sha }}" >> deployment-report.md
        echo "- **Fecha:** $(date)" >> deployment-report.md
        echo "" >> deployment-report.md
        echo "## âœ… Estado de Deployment" >> deployment-report.md
        echo "- **TestFlight:** ${{ needs.deploy-testflight.result == 'success' && 'âœ… Exitoso' || 'âŒ FallÃ³' }}" >> deployment-report.md
        echo "- **App Store:** ${{ needs.deploy-app-store.result == 'success' && 'âœ… Exitoso' || 'âŒ FallÃ³' }}" >> deployment-report.md
        echo "" >> deployment-report.md
        echo "## ğŸ“‹ Changelog" >> deployment-report.md
        echo "" >> deployment-report.md
        cat changelog.md >> deployment-report.md
        
    - name: ğŸ’¾ Subir Reporte
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment-report.md
        
    - name: ğŸ“§ Notificar por Email
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš€ Deployment Completado - v${{ needs.validate-release.outputs.version }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "Deployment Bot <${{ secrets.EMAIL_USERNAME }}>"
        body: |
          ## ğŸš€ Deployment Completado
          
          **App:** PronÃ³stico Fertilidad
          **VersiÃ³n:** ${{ needs.validate-release.outputs.version }}
          **Fecha:** $(date)
          
          ### ğŸ“± Estado:
          - TestFlight: ${{ needs.deploy-testflight.result == 'success' && 'âœ… Exitoso' || 'âŒ FallÃ³' }}
          - App Store: ${{ needs.deploy-app-store.result == 'success' && 'âœ… Exitoso' || 'âŒ FallÃ³' }}
          
          ### ğŸ“‹ Changelog:
          $(cat changelog.md)
          
          ### ğŸ” Detalles:
          - Build: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Autor: ${{ github.actor }}
          
          ğŸ“Š [Ver reporte completo](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

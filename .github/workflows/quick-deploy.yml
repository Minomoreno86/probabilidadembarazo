name: üöÄ Quick Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deployment'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - app-store
      version:
        description: 'Versi√≥n (opcional)'
        required: false
        type: string

env:
  XCODE_VERSION: '16.0'
  IOS_VERSION: '18.5'

jobs:
  quick-deploy:
    name: üöÄ Quick Deploy
    runs-on: macos-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: üîê Setup Code Signing
      uses: apple-actions/import-codesigning-certs@v1
      
    - name: üèóÔ∏è Build R√°pido
      run: |
        echo "üèóÔ∏è Construyendo app..."
        
        # Build para archivo
        xcodebuild archive \
          -project "Pronostico fertilidad.xcodeproj" \
          -scheme "Pronostico fertilidad" \
          -configuration Release \
          -archivePath "PronosticoFertilidad.xcarchive" \
          -destination generic/platform=iOS \
          | xcpretty --color --simple
          
        echo "‚úÖ Build completado"
        
    - name: üì¶ Exportar IPA
      run: |
        echo "üì¶ Exportando IPA..."
        
        # Crear exportOptions.plist
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>\${{ secrets.APP_STORE_TEAM_ID }}</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF
        
        # Exportar IPA
        xcodebuild -exportArchive \
          -archivePath "PronosticoFertilidad.xcarchive" \
          -exportPath "export" \
          -exportOptionsPlist "exportOptions.plist" \
          | xcpretty --color --simple
          
        echo "‚úÖ IPA exportado"
        
    - name: üì± Deploy a TestFlight
      if: inputs.environment == 'testflight'
      uses: apple-actions/upload-testflight@v1
      with:
        app-path: export/Pronostico\ fertilidad.ipa
        api-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        api-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        
    - name: üè™ Deploy a App Store
      if: inputs.environment == 'app-store'
      uses: apple-actions/upload-testflight@v1
      with:
        app-path: export/Pronostico\ fertilidad.ipa
        api-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        api-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        
    - name: üìß Notificar √âxito
      run: |
        echo "üéâ Deployment exitoso!"
        echo "üåç Ambiente: ${{ inputs.environment }}"
        if [ "${{ inputs.version }}" != "" ]; then
          echo "üè∑Ô∏è Versi√≥n: ${{ inputs.version }}"
        fi
        echo "üì± App desplegada correctamente"
        
    - name: üíæ Subir Artefactos
      uses: actions/upload-artifact@v4
      with:
        name: quick-deploy-${{ inputs.environment }}
        path: |
          export/
          PronosticoFertilidad.xcarchive
